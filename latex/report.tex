\documentclass[letter,12pt,notitlepage]{article}
\usepackage[left=4cm, right=2.5cm, top=2.5cm, bottom=2.5cm]{geometry}
\usepackage[shortlabels]{enumitem}
\usepackage{graphicx}
\usepackage{todonotes}
\usepackage{amsmath}
\usepackage[titletoc,title]{appendix}
\usepackage{amssymb}
\usepackage{makecell}
\usepackage{wrapfig}
\usepackage{verbatim}
\usepackage{listings}
\usepackage{minted}
\usepackage{subfig}
\usepackage{titling}
\usepackage[compatibility=false]{caption}
\usepackage[parfill]{parskip}
\setlength{\droptitle}{1cm}
\usepackage{hyperref}
\hypersetup{
    colorlinks,
    citecolor=black,
    filecolor=black,
    linkcolor=black,
    urlcolor=black
}
\usepackage{setspace}
\renewcommand{\topfraction}{0.85}
\renewcommand{\textfraction}{0.1}
\renewcommand{\floatpagefraction}{0.75}
\usepackage[
    %backend=biber, 
    natbib=true,
    style=numeric,
    sorting=none,
]{biblatex}
\addbibresource{citations.bib}
\input{variables.tex}

\setcounter{biburllcpenalty}{7000}
\setcounter{biburlucpenalty}{8000}

\newenvironment{tight_enumerate}{
\begin{enumerate}
  \setlength{\itemsep}{0pt}
  \setlength{\parskip}{0pt}
}{\end{enumerate}}

\newenvironment{tight_itemize}{
\begin{itemize}
  \setlength{\itemsep}{0pt}
  \setlength{\parskip}{0pt}
}{\end{itemize}}

\newlength{\mintednumbersep}
\AtBeginDocument{%
  \sbox0{\tiny00}%
  \setlength\mintednumbersep{8pt}%
  \addtolength\mintednumbersep{-\wd0}%
}

\title{\ThesisTitle}

\author{\vspace{1em}\\Sevag Hanssian \\
  McGill University \\
 \small{\texttt{sevag.hanssian@mail.mcgill.ca}} \\
 \small{\texttt{sevagh@protonmail.com}} \\\ \\\ \\
 \small{Thesis for Master of Arts in Music Technology}\\
 \small{Date TBD, 2021}}

% nil out the auto date
\date{}

\begin{document}

\maketitle

\vspace{3.5em}

\begin{abstract}
	The short-time Fourier transform (STFT) is an important tool for the time-frequency analysis of acoustic signals. The STFT is commonly used as the input representation of music signals in deep learning models. Examples of music information retrieval (MIR) tasks where such models have achieved success are onset detection, beat tracking, and music source separation. Despite its ubiquity, the STFT has a fixed and bounded time-frequency resolution, such that one must sacrifice time for frequency resolution (or vice versa) by changing the window size. The Nonstationary Gabor Transform (NSGT) is an adaptive time-frequency transform which can vary its time-frequency resolution to better represent music signals. In this thesis, first the STFT and NSGT are described as tools for representing and manipulating music signals. Next, the STFT is replaced with different configurations of the NSGT in deep learning models for onset detection, beat tracking, and music source separation respectively, showing significant improvements in the results.
\end{abstract}

\vfill
\clearpage %force a page break

\tableofcontents

\vfill
\clearpage %force a page break

\listoffigures

\listoflistings

\vfill
\clearpage %force a page break

\section{Introduction}
\label{sec:intro}

\subsection{Motivation}

\subsection{Thesis objective}

\subsection{Related work}

\subsection{Contribution and results}

\subsection{Outline}

This thesis is organized as follows. Section \ref{sec:theorystandard} will cover the theory of the DFT and its fast FFT implementation, and their use in music systems. Section \ref{sec:theoryvariant} will describe several variants of the FFT that may be useful for music applications. Section \ref{sec:libraries} will describe and benchmark existing open-source FFT libraries, and develop a new FFT library containing implementations of the studied variants. Section \ref{sec:results} will describe the outputs and performance analysis of the variants in the new library, as well as results achieved in a real-world music system by substituting the standard FFT with each variant. Finally, section \ref{sec:conclusion} will discuss the findings and explore whether there is value in using a variant instead of the standard FFT when creating new music systems.

\vfill
\clearpage

\section{Short-time Fourier transform}
\label{sec:theorystft}

\vfill
\clearpage

\section{Nonstationary Gabor transform}
\label{sec:theorynsgt}

\subsection{Theoretical background}

\todo[inline]{frame theory and shit}

\subsection{Irregular time and frequency sampling}

\todo[inline]{arbitrary f scales and time scales}

\subsection{Implementation details and computation cost}

\todo[inline]{how many windows, how many FFTs}

\subsection{Output coefficients and dimensions}

\todo[inline]{whats the output, what does it mean, how does it relate to the FFT coefficients, time-frequency matrix}

\vfill
\clearpage

\section{Onset detection and beat tracking}
\label{sec:beattrack}

\vfill
\clearpage

\section{Music source separation}
\label{sec:musicsep}

\subsection{Task definition and survey}

The task of music source separation is to split a mixed song into its constituent components, or sources. \citet{musicsepgood} describe that music source separation could operate on the level of instruments, or for broader categories of sources, grouped into harmonic, percussive, and singing voice.

Surveys on speech \cite{speechmask} and music separation \cite{musicmask} indicate that the majority of separation algorithms use the technique of time-frequency masking (or spectral masking) to separate the sources.

\begin{wrapfigure}{r}{8cm}
	\vspace{-1.0em}
	\includegraphics[width=8cm]{./maskdemo.png}
	\caption{Results of a soft and hard oracle mask applied for speech denoising. The oracle mask is the ideal mask for a given signal -- to compute it, the target and interference signals must be known.}
	\label{fig:masks}
	\vspace{-1.5em}
\end{wrapfigure}

\citet{masking} describe different time-frequency masking strategies in audio source separation. A time-frequency mask (or spectral mask, or masking filter) is a matrix of the same size as the complex STFT, by which the STFT is multiplied to mask, filter, or suppress specific time-frequency bins. A soft mask has real values $\in [0.0, 1.0]$, and a binary or hard mask has logical values, i.e., only 0 and 1. The soft mask used in \cite{fitzgerald1, fitzgerald2} is a Wiener filter given in the following equation, where $\hat{S}$ represents the complex-valued spectrogram:
\[ M_{\text{target}} = \frac{|\hat{S}_{\text{target}}|^{2}}{|\hat{S}_{\text{interference}}|^{2} + |\hat{S}_{\text{target}}|^{2}} \]

Soft masks generally produce higher quality sound. An illustration of spectral masking is shown in figure \ref{fig:masks}.

Most recently, the SigSep\footnote{\url{https://sigsep.github.io/}} community has been running the Signal Separation Evaluation Campaign (SISEC), which sets the tone for the modern state-of-the-art models. SiSec uses the BSS (Blind Source Separation) Eval \cite{bss} objective measure for separation quality, or BSSv4 variant.

The most popular music stem dataset used by SISEC and SigSep is the MUSDB18 dataset \cite{musdb18} (or the HQ, high-quality, equivalent \cite{musdb18-hq}). MUSDB18-HQ contains stereo wav files sampled at 44100 Hz representing stems (drum, vocal, bass, and other) from a collection of permissively licensed music, specifically intended for recording, mastering, mixing (and in this case, ``de-mixing'', or source separation) research.

In modern music source separation, the stems of MUSDB18 have determined the four most common sources to separate -- drums, bass, vocals, and other. SigSep's own network, Open-Unmix, is trained only on MUSDB18, and produces near-state-of-the-art results. The absolute state-of-the-art crown is jointly held by Conv-Tasnet and Demucs, both of which surpass Open-Unmix. Both models operate directly on the waveform domain, which indicates that they could surpass the maximum possible poerformance of time-frequency masking approaches, as is done in speech separation. However, in practise they are still below the limits of masking-based approaches.

\subsection{NSGTs for music source separation}

\subsubsection{Constant-Q transform}

\subsubsection{ERB and the Variable-Q transform}

\subsubsection{Mel and Bark NSGT}

\subsection{Surpassing the ideal oracle mask}

The first experiment to run is to discover which configuration of the NSGT has the potential to surpass the maximum performance of time-frequency masking using the spectrogram. Given ground truth data, such as what is available in MUSDB18, we have available to us the individually recorded sources for each track. From this, we can compute the ideal or oracle masks::

\begin{flalign}
	\nonumber \text{given: } & x_{\text{drums}}, x_{\text{vocals}}, x_{\text{bass}}, x_{\text{other}}\\
	\nonumber & x_{\text{mix}} = \sum{x}\\
	\nonumber & \hat{X} = \text{STFT}(x), \text{complex-valued}\\
	\nonumber & |\hat{X}|^{\alpha} = \text{magnitude STFT of } x \text{ raised to } \alpha \text{ power, real-valued}\\
	\nonumber & \text{Mask}_{\text{source}} = \frac{|\hat{X}|_{\text{source}}^{\alpha}}{\sum{|\hat{X}|^{\alpha}}}\\
	\nonumber & \hat{Y}_{\text{source}} = \text{Mask}_{\text{source}} * \hat{X}_{\text{mix}}\\
	\nonumber & y = \text{ISTFT}(\hat{Y})\\
	\nonumber & y = \text{ideal estimate of } x
\end{flalign}

Finally, using these pairs of $x, y$, we can get the maximum possible BSS metrics of any algorithm or model based on time-frequency masking. This is the methodology used to find the so-called oracle estimator or oracle mask, which represents the maximum possible performance of any algorithm or model for music source separation that uses spectrogram masking (CITE UMX, etc.).

Approaching or surpassing the ideal mask performance is a common benchmark in source separation literature. \todo{weak} Demucs talks about it but doesn't achieve it.


\subsubsection{Evaluated NSGT parameters}

A testbench was designed to select 5 random tracks from MUSDB18-HQ at a time and evaluate a range of NSGT parameters. The same 5 random tracks are re-used by explicitly setting the Python RNG seed to a fixed integer. This way repeated experiments would be using the same tracks, creating a consistent evaluation. The tracks are split into the first 12 10 second chunks (representing 2 minutes of music), and the bottom half of the configurations in median SDR score are pruned after each chunk to reduce the solution space of the parameter search.

Table \ref{table:nsgtparamsirm} contains the parameter ranges of the evaluated NSGT configs and the rationale for their selection. The maximum frequency was fixed to 22050 (or 44100/2), the Nyquist frequency of MUSDB18-HQ. The median score across all targets' SDR metric was considered to rank the configurations, and low performers (bottom 100) were periodically pruned during the testbench to reduce runtime.

\begin{table}[ht]
	\centering
\begin{tabular}{ |l|l|l|c|c|c| }
	 \hline
	  Parameter & Values & Rationale \\
	 \hline
	 \hline
	 Scale & CQ-Log, VQ-Log, Bark, Mel & dabest \\
	 \hline
	 Bins & 12-348, steps of 12 & \makecell[l] { Constant-Q transform is based on the \\ 12-tone pitch scale and bins \\ are commonly given in multiples of 12 } \\
	 \hline
	 Fmin & 15-60 Hz, steps of 0.1 Hz & \makecell[l] { Starting frequency band, from slightly below \\ the psychoacoustic limit of 20Hz \\ and extending to 60Hz to include 32.7, 57Hz } \\
	 \hline
	 Gamma & 0-100 Hz, steps of 1 Hz & \makecell[l] { \textbf{VQ-Log only}\\Pick low values in a neighborhood \\ near 25 Hz cite suggestion } \\
	 \hline
\end{tabular}
	\caption{NSGT parameter ranges evaluated}
	\label{table:nsgtparamsirm}
\end{table}

Note that although the variable-Q transform (VQT) using the VQ-Log scale dramatically improves on the performance of the CQ-Log scale, the Bark and Mel scales outperform both. Several plots of the intermediate results are shown in figure \ref{fig:melnsgt}. One can observe that, ignoring anomalies, the best performers are in the region of 230--250 bins, using the Mel scale, and a starting frequency between 25-30 Hz.

The results led to the best NSGT selected as the Mel-frequency NSGT using 234 frequency bins and a starting frequency of 27.5 Hz. Further refinement would have been possible, such as reducing the bin step to 1 bin, or the frequency step to 0.1 Hz, but as mentioned, the resulting testbenches would be infeasible to run due to the large number of configurations. Moreover, the value of 27.5 Hz is coincidental with the lowest frequency on a standard piano, providing additional musical justification for its use.

\begin{figure}[ht]
	\centering
	\includegraphics[width=16cm]{./mel_nsgt_params.png}
	\caption{SDR scores of evaluated NSGT configurations}
	\label{fig:melnsgt}
\end{figure}

\subsubsection{BSS performance optimizations}

\subsubsection{NSGT ideal mask results}

\subsection{Advancing the state-of-the-art with the NSGT}

\todo[inline]{better hope umx shines here}

\subsubsection{Adapting Open-Unmix to use the NSGT}

\subsubsection{Network size and training}

\subsubsection{Results}

\vfill
\clearpage

\section{Conclusions}
\label{sec:conclusion}

foo

\subsection{Evaluation}

foo

\subsection{Outlook}

foo

\subsection{Summary}

foo

\vfill
\clearpage % force a page break before references

%\nocite{*}
\section{References}
\printbibliography[heading=none]

\vfill
\clearpage %force a page break

\begin{appendices}

\section{Code availability and replicating the results}
\label{appendix:coderesultsrepro}

\end{appendices}

\end{document}
